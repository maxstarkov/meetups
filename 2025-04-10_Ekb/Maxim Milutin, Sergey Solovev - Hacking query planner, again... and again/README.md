# Хакинг оптимизатора запросов, снова... и снова

## О чем доклад

В докладе мы сосредоточимся на первой стадии оптимизации запросов, известной как препроцессинг исходной структуры запроса.

Слушатели узнают, какие шаги нормализации и необратимых трансформаций применяются к дереву запроса до начала процедуры стоимостного перебора джоинов.

Раскроем такие нюансы как:

- выравнивание подзапросов в предикатах ANY/EXISTS/IN
- выравнивание SELECT-подзапросов
- преобразование джоинов OUTER в INNER
- препроцессинг выражений
- удаление ненужных джоинов
- проброс табличных предикатов к сканам таблиц и др. 

Для DBA и SQL-разработчиков постараемся раскрыть некоторые инсайты и хаки, которые позволят сделать запрос более производительным, а план запроса — более управляемым.

Данный доклад построен и значительно пересекается с двумя прошлыми докладами на эту тему от Тома Лейна в 2011 году "Hacking the Query Planner" и "Hacking the Query Planner, Again" от Ричарда Гуо в 2020, однако мы сделаем акцент на реализации описанных концепций в исходном коде и в конце доклада на примере покажем патч трансформации, который способен улучшить производительность определенного класса запросов в несколько раз.

## Практическая часть

В практической части мы рассмотрим реализацию 2 оптимизаций - декорреляция подзапросов и Join pushdown.
Обе они нужны для оптимизации запроса #17 из бенчмарка TPC-H.

В файле [`subquery-decorrelation.patch`](./subquery-decorrelation.patch) находится патч с реализованными оптимизациями.
Патч необходимо применить для версии 16.8.
Для применения можно использовать команду `patch`:

```bash
# Скачиваем исходный код
wget https://ftp.postgresql.org/pub/source/v16.8/postgresql-16.8.tar.gz
tar -xf postgresql-16.8.tar.gz

# Применяем патч
cd postgresql-16.8
patch -p1 <../subquery-decorrelation.patch
```

При запуске БД необходимо выставить параметры GUC:

```text
enable_hashjoin = off
enable_mergejoin = off
```

Запрос 17 из TPC-H находится в файле [`tpch-17.sql`](./tpch-17.sql).

